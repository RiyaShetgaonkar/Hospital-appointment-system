<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Patient Panel</title>
  <link rel="stylesheet" href="style.css">
   <style>
        body { background-color: #f0f8ff; font-family: 'Segoe UI', sans-serif; color: #003366; margin: 0; padding: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        .container { background-color: #ffffff; padding: 40px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0, 51, 102, 0.15); width: 100%; max-width: 400px; text-align: center; border: 1px solid #e0e0e0; }
        h2 { color: #003366; margin-bottom: 20px; font-size: 24px; font-weight: 600; }
        label { display: block; text-align: left; margin-bottom: 5px; font-weight: bold; color: #003366; }
        input[type="text"], input[type="date"] { border: 2px solid #b0c4de; padding: 12px; margin: 10px 0; width: 100%; box-sizing: border-box; border-radius: 5px; background-color: #f9f9f9; font-size: 16px; color: #003366; transition: border-color 0.3s ease; }
        .back-button { background-color: #4682b4; color: white; padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; text-decoration: none; display: inline-block; margin-bottom: 20px; font-weight: 500; transition: background-color 0.3s ease; }
        .back-button:hover { background-color: #003366; }
        
        /* New Style for ETA */
        #etaBox { font-size: 18px; color: #d9534f; font-weight: bold; margin-bottom: 20px; }
    </style>
</head>

<body>
  <div class="container">
    <h1>Take Appointment</h1>

    <p><strong>Patient:</strong> <span id="patientName">Loading...</span></p>

    <label>Select Clinic</label>
    <select id="clinic">
      <option value="">Select Clinic</option>
      <option value="Dermatology">Dermatology</option>
      <option value="Orthopedics">Orthopedics</option>
      <option value="Cardiology">Cardiology</option>
      <option value="ENT">ENT</option>
    </select>
     <button id="submit">Get Token</button>

    <h3>Your Token</h3>
    <div id="tokenBox">â€”</div>
    
    <h3>Estimated Wait Time</h3>
    <div id="etaBox">Select a clinic...</div>

   

     <a href="dashboard.html" class="back-button">Back to Dashboard</a>
        <a href="doctor.html" class="back-button">GO to Doctors panel</a>
  </div>


<script type="module">
const BASE_URL = "https://hospital-appointment-system-oogs.onrender.com";
// 1. IMPORT AVG_TIME HERE
import { db, AVG_TIME } from "./app.js";

import {
  collection,
  addDoc,
  getDocs,
  serverTimestamp,
  onSnapshot // 2. IMPORT onSnapshot
} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

import {
  getAuth,
  onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

const auth = getAuth();

const clinicSelect = document.getElementById("clinic");
const submitBtn = document.getElementById("submit");
const tokenBox = document.getElementById("tokenBox");
const patientNameUI = document.getElementById("patientName");
const etaBox = document.getElementById("etaBox"); // 3. GET ETA ELEMENT

let firebaseUser = null;
let userData = null;
let unsubscribe = null; // To stop listening when switching clinics

/* ðŸ” Get logged-in user + profile data */
onAuthStateChanged(auth, async (user) => {
  if (!user) {
    window.location.href = "login.html";
    return;
  }

  firebaseUser = user;
  const token = await user.getIdToken();

  const response = await fetch(`${BASE_URL}/api/auth/profile-data`, {
    headers: { Authorization: `Bearer ${token}` }
  });

  userData = await response.json();
  patientNameUI.textContent = userData.name || "Unknown";
});

/* ðŸ•’ NEW: Calculate ETA when clinic changes */
clinicSelect.onchange = () => {
  // Stop listening to the previous clinic (if any)
  if (unsubscribe) unsubscribe();

  const clinic = clinicSelect.value;
  if (!clinic) {
      etaBox.textContent = "Select a clinic...";
      return;
  }

  // Listen to the queue count in real-time
  const queueRef = collection(db, "queue", clinic, "patients");
  
  unsubscribe = onSnapshot(queueRef, (snapshot) => {
      const count = snapshot.size; // Total people in queue
      const waitTime = count * AVG_TIME;
      
      if (count === 0) {
          etaBox.textContent = "0 mins (You are next!)";
          etaBox.style.color = "green";
      } else {
          etaBox.textContent = `~${waitTime} minutes (${count} people ahead)`;
          etaBox.style.color = "#d9534f";
      }
  });
};

/* ðŸ“ Book appointment */
submitBtn.onclick = async () => {
  if (!firebaseUser || !userData) {
    alert("User data not loaded");
    return;
  }

  const clinic = clinicSelect.value;
  if (!clinic) {
    alert("Select clinic");
    return;
  }

  // Get current queue size for token number
  const snap = await getDocs(
    collection(db, "queue", clinic, "patients")
  );

  const tokenNumber = snap.size + 1;

  await addDoc(
    collection(db, "queue", clinic, "patients"),
    {
      uid: firebaseUser.uid,
      name: userData.name || "N/A",
      phone: userData.phone || "N/A",
      email: firebaseUser.email || "N/A",
      dob: userData.dob || "N/A",
      token: tokenNumber,
      time: serverTimestamp()
    }
  );

  tokenBox.textContent = tokenNumber;
  alert(`Token ${tokenNumber} Booked!`);
};
</script>

</body>
</html>