<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GMC Doctor Panel - Queue Monitor</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
       body { 
    
    /* background: url('Hero.jpg') no-repeat center center fixed;  */
     /* Ensures the image covers the whole screen */
    
    font-family: 'Roboto', sans-serif; 
    color: #2c3e50; 
    margin: 0; 
    padding: 0; 
     background: linear-gradient(135deg, #EDE7E3 0%, #82C0CC 50%, #489FB5 100%);
    min-height: 100vh; 
}
        header { background-color: #16697A; padding: 15px 40px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); border-bottom: 3px solid #3498db; }
        .logo-container { display: flex; align-items: center; }
        .logo-img { width: 45px; height: 45px; margin-right: 15px; border-radius: 50%; object-fit: cover; }
        .logo { font-size: 28px; color:#EDE7E3; font-weight: 700; }
        
        .logout-btn { background-color: #e74c3c; color: white; border: none; padding: 10px 18px; border-radius: 8px; cursor: pointer; font-weight: 600; transition: 0.3s; }
        .logout-btn:hover { background-color: #c0392b; }

        .main-body { padding: 40px 20px; display: flex; flex-direction: column; align-items: center; max-width: 1200px; margin: 0 auto; }
        .container { background-color:#EDE7E3; padding: 35px; border-radius: 16px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); width: 100%; max-width: 600px; text-align: center; border: 1px solid #e1e8ed; position: relative; }
        .container::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 4px; background: linear-gradient(90deg, #3498db 0%, #5dade2 50%, #85c1e9 100%); }
        
        h1 { color: #2c3e50; margin-bottom: 10px; font-size: 28px; font-weight: 700; }
        #doctorWelcome { color: #7f8c8d; font-size: 16px; margin-bottom: 25px; }

        label { font-weight: 600; color: #2c3e50; display: block; text-align: left; margin-bottom: 8px; }
        select { width: 100%; padding: 12px; margin-bottom: 20px; border-radius: 8px; border: 2px solid #b0c4de; font-size: 16px; background-color: #f1f4f8; cursor: not-allowed; }

        .current-patient-box { background: linear-gradient(135deg, #e3f2fd 0%, #f1f8ff 100%); padding: 25px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #b3d7ff; }
        #currentPatient { font-size: 30px; font-weight: bold; color: #3498db; }
        
        #nextBtn { background-color: #3498db; color: white; border: none; padding: 16px; border-radius: 8px; font-size: 18px; cursor: pointer; width: 100%; font-weight: bold; transition: 0.3s; box-shadow: 0 4px 10px rgba(52, 152, 219, 0.3); }
        #nextBtn:hover { background-color: #2980b9; transform: translateY(-2px); }

        #queueList { list-style: none; padding: 0; margin-top: 20px; text-align: left; max-height: 250px; overflow-y: auto; }
        #queueList li { padding: 12px 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; background-color: #f9f9f9; border-radius: 8px; margin-bottom: 8px; }
        
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; display: none; justify-content: center; align-items: center; }
        .modal-content { background: white; width: 95%; max-width: 500px; border-radius: 12px; padding: 25px; box-shadow: 0 5px 25px rgba(0,0,0,0.3); max-height: 85vh; overflow-y: auto; }
        
        .view-btn { background: #2ecc71; color: white; border: none; padding: 6px 12px; border-radius: 5px; cursor: pointer; font-size: 13px; }
        .view-btn:hover { background: #27ae60; }
        
        .consultation-form input { width: 100%; padding: 10px; margin-bottom: 12px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }

        #resetBtn { background-color: #e74c3c; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: bold; margin-top: 20px; transition: 0.3s; width: 100%; }
        #resetBtn:hover { background-color: #c0392b; }

        #addPatientBtn { background-color: #2ecc71; color: white; border: none; padding: 16px; border-radius: 8px; font-size: 18px; cursor: pointer; width: 100%; font-weight: bold; transition: 0.3s; box-shadow: 0 4px 10px rgba(46, 204, 113, 0.3); margin-top: 10px; }
        #addPatientBtn:hover { background-color: #27ae60; transform: translateY(-2px); }
    </style>
</head>

<body>
    <header>
        <div class="logo-container">
            <img src="logo.jpeg" alt="Logo" class="logo-img">
            <div class="logo">Care Connect <span style="font-weight: 300; font-size: 0.6em; color: white;">STAFF</span></div>
        </div>
        <button id="logoutBtn" class="logout-btn"><i class="fas fa-sign-out-alt"></i> Logout</button>
    </header>

    <div class="main-body">
        <div class="container">
            <h1 id="clinicHeader">Doctor Panel</h1>
            <div id="doctorWelcome">Verifying GMC Credentials...</div>

            <label for="clinicSelect">Your Assigned Clinic</label>
            <select id="clinicSelect" disabled>
                <option value="">-- Assigned Clinic --</option>
                <option value="Dermatology">Dermatology</option>
                <option value="Orthopedics">Orthopedics</option>
                <option value="Cardiology">Cardiology</option>
                <option value="ENT">ENT</option>
            </select>

            <div class="current-patient-box">
                <h3 style="margin-top:0;">Now Serving</h3>
                <div id="currentPatient">None</div>
                <div id="statusMsg" style="display:none; color:green; margin-top:10px; font-weight:bold;"></div>
                <button id="viewCurrentBtn" style="display:none; margin-top:15px; background:#2ecc71; border:none; color:white; padding:8px 20px; border-radius:6px; cursor:pointer; font-weight:bold;">
                    ‚úÖ Update Medical Record
                </button>
            </div>

            <button id="nextBtn">Call Next Patient</button>

            <div style="margin-top: 30px; text-align: left;">
                <strong style="color: #34495e;">Live Waiting Queue:</strong>
                <ul id="queueList"></ul>
            </div>

            <div style="margin-top: 15px; font-weight: bold; color: #7f8c8d;">
                Estimated Queue Clearance: <span id="eta" style="color: #e74c3c;">‚Äî</span>
            </div>

            <button id="addPatientBtn"><i class="fas fa-user-plus"></i> Add Patient</button>

            <div id="addPatientModalOverlay" class="modal-overlay">
                <div id="add-patient-modal" class="modal-content">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <h2 style="margin:0;">Add New Patient</h2>
                        <button onclick="closeAddPatientModal()" style="border:none; background:none; font-size:24px; cursor:pointer;">&times;</button>
                    </div>
                    <hr>
                    <div class="consultation-form">
                        <label>Patient Name</label>
                        <input type="text" id="patientName" placeholder="Enter patient name" required>
                        <label>Phone Number</label>
                        <input type="tel" id="patientPhone" placeholder="Enter phone number" required>
                        <button onclick="addPatientToQueue()" style="width:100%; background:#27ae60; color:white; border:none; padding:12px; border-radius:6px; cursor:pointer; font-weight:bold;">Add Patient</button>
                    </div>
                </div>
            </div>

            <button id="resetBtn"><i class="fas fa-sync-alt"></i> Restart Tokens from #1</button>
        </div>
    </div>

    <div id="modalOverlay" class="modal-overlay">
        <div id="patient-details-modal" class="modal-content"></div>
    </div>

<script type="module">
    import { db, AVG_TIME } from "./app.js";
    import { collection, getDocs, deleteDoc, query, orderBy, onSnapshot, doc, setDoc, getDoc, updateDoc, arrayUnion, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

    const auth = getAuth();
    const clinicSelect = document.getElementById("clinicSelect");
    const queueList = document.getElementById("queueList");
    const currentBox = document.getElementById("currentPatient");
    const viewCurrentBtn = document.getElementById("viewCurrentBtn");
    const etaBox = document.getElementById("eta");
    const nextBtn = document.getElementById("nextBtn");
    const doctorWelcome = document.getElementById("doctorWelcome");
    const clinicHeader = document.getElementById("clinicHeader");

    let queueRef = null;
    let unsubscribe = null;
    let currentDocName = "Dr. On Duty";

    onAuthStateChanged(auth, async (user) => {
        if (!user) { window.location.href = "login.html"; return; }
        try {
            const docSnap = await getDoc(doc(db, "doctors", user.uid));
            if (docSnap.exists()) {
                const data = docSnap.data();
                currentDocName = data.name || "Dr. On Duty";
                doctorWelcome.textContent = `Welcome, ${currentDocName}`;
                clinicHeader.textContent = `${data.clinic} Panel`;
                clinicSelect.value = data.clinic;
                startQueueListener(data.clinic);
            } else {
                alert("Access Denied: Patient accounts cannot access the Doctor Panel."); 
                await signOut(auth); 
                window.location.href = "login.html";
            }
        } catch (error) { console.error(error); }
    });

    document.getElementById("logoutBtn").onclick = () => signOut(auth).then(() => window.location.href = "dlogin.html");

    // üöÄ SMART SYNC: RE-SYNC GOOGLE SHEETS LOGIC
    async function syncThirdPersonToSheets(patients, clinic) {
        if (patients.length >= 3) {
            const thirdPerson = patients[2]; 
            const data = thirdPerson.data();

            if (!data.notified) {
                // üõë CHECK: If patient is marked manual, skip Google Sheets sync
                if (data.source === "manual") {
                    console.log(`üö´ Skipping Sheets sync for manual entry: ${data.name}`);
                    await updateDoc(thirdPerson.ref, { notified: true });
                    return;
                }

                const isInternalEmail = data.email && data.email.toLowerCase().endsWith("@careconnect.com");
                if (isInternalEmail) {
                    console.log(`üö´ Skipping Sheets sync for internal user: ${data.email}`);
                    await updateDoc(thirdPerson.ref, { notified: true });
                    return;
                }

                try {
                    const idToken = await auth.currentUser.getIdToken();
                    const isLocal = window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1";
                    const BASE_URL = isLocal ? "http://localhost:5000" : "https://hospital-appointment-system-oogs.onrender.com";

                    await fetch(`${BASE_URL}/api/auth/trigger-instant-relay`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json", "Authorization": `Bearer ${idToken}` },
                        body: JSON.stringify({
                            userName: data.name,
                            phone: data.phone,
                            clinicName: clinic,
                            tokenNumber: data.token,
                            email: data.email || "manual@entry.none"
                        })
                    });

                    await updateDoc(thirdPerson.ref, { notified: true });
                    console.log(`‚úÖ Sheets Relay: Recorded ${data.name} (3rd person)`);
                } catch (e) { console.error("Sheets sync failed:", e); }
            }
        }
    }

    function startQueueListener(clinic) {
        if (unsubscribe) unsubscribe();
        queueRef = collection(db, "queue", clinic, "patients");
        const q = query(queueRef, orderBy("time", "asc"));

        unsubscribe = onSnapshot(q, (snapshot) => {
            queueList.innerHTML = "";
            const allPatients = snapshot.docs;

            syncThirdPersonToSheets(allPatients, clinic);

            snapshot.forEach((docSnap) => {
                const d = docSnap.data();
                const li = document.createElement("li");
                li.innerHTML = `<span><strong>Token #${d.token}</strong> ${d.source === 'manual' ? '<span style="font-size:10px; color:#e67e22;">[MANUAL]</span>' : ''}<br><small>${d.name} | ${d.phone || 'N/A'}</small></span> <button class="view-btn" onclick="window.viewPatientDetails('${d.uid}', false)">View History</button>`;
                queueList.appendChild(li);
            });
            etaBox.textContent = allPatients.length > 0 ? `${allPatients.length * AVG_TIME} minutes` : "Queue Empty";
        });
    }

    nextBtn.onclick = async () => {
        const clinic = clinicSelect.value;
        if (!clinic || !queueRef) return;
        const q = query(queueRef, orderBy("time", "asc"));
        const snap = await getDocs(q);
        if (snap.empty) { currentBox.textContent = "None"; viewCurrentBtn.style.display = "none"; return; }

        const firstDoc = snap.docs[0];
        const currentServingData = firstDoc.data();

        currentBox.innerHTML = `Token #${currentServingData.token}<br><small>${currentServingData.name}</small>`;
        viewCurrentBtn.style.display = "inline-block";
        viewCurrentBtn.onclick = () => window.viewPatientDetails(currentServingData.uid, true);

        await setDoc(doc(db, "clinic_status", clinic), { currentlyServing: currentServingData.token }, { merge: true });
        await deleteDoc(firstDoc.ref);
        try {
             // Detect Environment
             const isLocal = window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1";
             const BASE_URL = isLocal ? "http://localhost:5000" : "https://hospital-appointment-system-oogs.onrender.com";

             await fetch(`${BASE_URL}/api/notify/queue-update`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    currentPatientId: currentServingData.uid,
                    clinic: clinic
                })
            });
            console.log("Notification trigger sent");
        } catch (err) {
            console.error("Failed to trigger notification", err);
        }
        // ---------------------------------------------------------
    };

    window.viewPatientDetails = async (patientId, isEditable = false) => {
        const modal = document.getElementById("patient-details-modal");
        const overlay = document.getElementById("modalOverlay");
        modal.innerHTML = "<h4>Loading Records...</h4>";
        overlay.style.display = "flex";

        // Handle manual patients (they might not have a profile in 'users' collection)
        if (patientId.startsWith("manual-")) {
            modal.innerHTML = `
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h2 style="margin:0;">Walk-in Patient</h2>
                    <button onclick="closeModal()" style="border:none; background:none; font-size:24px; cursor:pointer;">&times;</button>
                </div>
                <hr><p>Manual entry: Detailed medical history not available for unregistered walk-ins.</p><hr>
                ${isEditable ? `<p style="color:red; font-size:12px;">Save visit is disabled for unregistered patients.</p>` : ""}
            `;
            return;
        }

        const docSnap = await getDoc(doc(db, "users", patientId));
        if (docSnap.exists()) {
            const data = docSnap.data();
            let historyHtml = (data.medicalHistory || []).slice().reverse().map(h => `
                <div style="border-bottom: 1px solid #eee; padding: 10px 0;">
                    <strong>${h.date}</strong>: ${h.diagnosis} <br>
                    <small>üíä Rx: ${h.medication || "None"} | ${h.department || "General"}</small>
                </div>`).join('') || '<p>No previous history.</p>';

            modal.innerHTML = `
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h2 style="margin:0;">${data.name}</h2>
                    <button onclick="closeModal()" style="border:none; background:none; font-size:24px; cursor:pointer;">&times;</button>
                </div>
                <hr><div style="max-height: 200px; overflow-y: auto; margin-bottom:15px;">${historyHtml}</div><hr>
                ${isEditable ? `
                    <div class="consultation-form">
                        <label>Diagnosis</label><input type="text" id="doc-diagnosis" placeholder="Viral Fever">
                        <label>Medication</label><input type="text" id="doc-prescription" placeholder="Paracetamol">
                        <button onclick="updatePatientRecord('${patientId}')" style="width:100%; background:#27ae60; color:white; border:none; padding:12px; border-radius:6px; cursor:pointer; font-weight:bold;">‚úÖ Save visit</button>
                    </div>` : ""}
            `;
        }
    };

    window.closeModal = () => document.getElementById("modalOverlay").style.display = "none";

    window.updatePatientRecord = async (patientId) => {
        const diag = document.getElementById("doc-diagnosis").value;
        const presc = document.getElementById("doc-prescription").value;
        if (!diag) return alert("Enter Diagnosis");
        const visit = {
            date: new Date().toLocaleDateString("en-US", { year: 'numeric', month: 'long', day: 'numeric' }),
            diagnosis: diag, medication: presc || "None", department: clinicSelect.value, doctor: currentDocName 
        };
        await updateDoc(doc(db, "users", patientId), { medicalHistory: arrayUnion(visit) });
        alert("Record Updated!");
        window.closeModal();
    };

    document.getElementById("resetBtn").onclick = async () => {
    const now = new Date();
    const hour = now.getHours();

    // üß† LOGIC: Block reset ONLY during active clinic hours (9 AM - 5 PM)
    // This allows reset anytime from 5:00 PM (17) until 8:59 AM (8)
    if (hour >= 9 && hour < 17) {
        alert("‚ö†Ô∏è Restriction: Tokens cannot be reset during active clinic hours (9:00 AM - 5:00 PM).");
        return;
    }

    const clinic = clinicSelect.value;
    if (!clinic) {
        alert("Please select a clinic first.");
        return;
    }

    if (confirm(`Reset ${clinic} token numbering to #1? Existing queue will remain, but new bookings start at #1.`)) {
        try {
            // Updated to use the professional palette color variables if needed
            await setDoc(doc(db, "clinic_status", clinic), { 
                currentlyServing: 0, 
                lastTokenIssued: 0 
            }, { merge: true });
            
            alert("‚úÖ Success: Token numbering has been reset for the next session.");
        } catch (error) { 
            alert("Reset Failed: " + error.message); 
        }
    }
};

    const addPatientBtn = document.getElementById("addPatientBtn");
    addPatientBtn.onclick = () => {
        document.getElementById("addPatientModalOverlay").style.display = "flex";
    };

    window.closeAddPatientModal = () => {
        document.getElementById("addPatientModalOverlay").style.display = "none";
        document.getElementById("patientName").value = "";
        document.getElementById("patientPhone").value = "";
    };

    window.addPatientToQueue = async () => {
        const name = document.getElementById("patientName").value.trim();
        const phone = document.getElementById("patientPhone").value.trim();
        const clinic = clinicSelect.value;

        if (!name || !phone || !clinic) {
            alert("Please fill in all fields.");
            return;
        }

        try {
            const statusDoc = await getDoc(doc(db, "clinic_status", clinic));
            let lastToken = 0;
            if (statusDoc.exists()) {
                lastToken = statusDoc.data().lastTokenIssued || 0;
            }
            const newToken = lastToken + 1;
            const manualId = `manual-${Date.now()}`;

            const patientData = {
                name: name,
                phone: phone,
                token: newToken,
                time: serverTimestamp(),
                uid: manualId,
                notified: false,
                source: "manual" // üè∑Ô∏è ADDED TAG AS REQUESTED
            };
            
            await setDoc(doc(queueRef, manualId), patientData);
            await updateDoc(doc(db, "clinic_status", clinic), { lastTokenIssued: newToken });

            alert(`Patient added with Token #${newToken}`);
            closeAddPatientModal();
        } catch (error) {
            console.error("Error adding patient:", error);
            alert("Failed to add patient. Please try again.");
        }
    };
</script>
</body>
</html>