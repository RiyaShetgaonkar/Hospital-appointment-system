<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GMC Doctor Portal - Login</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        body { background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%); font-family: 'Roboto', sans-serif; height: 100vh; display: flex; align-items: center; justify-content: center; margin: 0; }
        .login-container { background: white; padding: 40px; border-radius: 16px; box-shadow: 0 15px 35px rgba(0,0,0,0.2); width: 100%; max-width: 400px; text-align: center; }
        .hospital-logo { width: 80px; height: 80px; margin-bottom: 10px; border-radius: 50%; }
        h1 { color: #2c3e50; font-size: 24px; margin-bottom: 5px; }
        p { color: #7f8c8d; margin-bottom: 30px; font-size: 14px; }
        .input-group { text-align: left; margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: #34495e; }
        input { width: 100%; padding: 12px; border: 2px solid #ecf0f1; border-radius: 8px; box-sizing: border-box; font-size: 16px; transition: 0.3s; }
        input:focus { border-color: #3498db; outline: none; }
        #loginBtn { background-color: #3498db; color: white; border: none; padding: 15px; width: 100%; border-radius: 8px; font-size: 18px; font-weight: bold; cursor: pointer; transition: 0.3s; margin-top: 10px; }
        #loginBtn:hover { background-color: #2980b9; }
        .footer-link { margin-top: 20px; display: block; color: #3498db; text-decoration: none; font-size: 13px; }
    </style>
</head>
<body>

<div class="login-container">
    <img src="logo.jpeg" alt="GMC Logo" class="hospital-logo">
    <h1>Doctor Portal</h1>
    <p>General Medical Center (GMC)</p>

    <div class="input-group">
        <label>Institutional Email</label>
        <input type="email" id="email" placeholder="doctor.name@hospital.com">
    </div>

    <div class="input-group">
        <label>Access Password</label>
        <input type="password" id="password" placeholder="••••••••">
    </div>

    <button id="loginBtn">Secure Login</button>
    
    <a href="login.html" class="footer-link">Are you a patient? Go to Patient Login</a>
</div>

<script type="module">
    import { db } from "./app.js";
    import { getAuth, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
    import { doc, getDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    const auth = getAuth();
    const loginBtn = document.getElementById("loginBtn");

    loginBtn.onclick = async () => {
        const email = document.getElementById("email").value.trim();
        const password = document.getElementById("password").value;

        if(!email || !password) return alert("Please fill all fields");

        loginBtn.disabled = true;
        loginBtn.innerText = "Authenticating...";

        try {
            // 1. Authenticate with Firebase Auth
            const userCredential = await signInWithEmailAndPassword(auth, email, password);
            const user = userCredential.user;
            
            console.log("--- GMC Auth Debug ---");
            console.log("Logged in UID:", user.uid);

            // 2. Fetch from 'doctors' collection
            const doctorRef = doc(db, "doctors", user.uid);
            const doctorDoc = await getDoc(doctorRef);
            
            if (doctorDoc.exists()) {
                const data = doctorDoc.data();
                console.log("Success! Doctor Data:", data);
                
                // Final Check: Does the document have a clinic field?
                if (data.clinic) {
                    window.location.href = "doctor.html";
                } else {
                    console.error("Missing Field: 'clinic' not found in document.");
                    alert("Account Error: Clinic department not assigned in database.");
                    await signOut(auth);
                }
            } else {
                // This means Auth worked, but the Firestore Document ID is wrong
                console.error("Database Error: No document found in 'doctors' collection with ID: " + user.uid);
                alert("Access Denied: GMC Staff record not found. Please contact IT.");
                await signOut(auth);
                window.location.reload();
            }
        } catch (error) {
            console.error("Login Error:", error.code, error.message);
            alert("Login Failed: " + error.message);
        } finally {
            loginBtn.disabled = false;
            loginBtn.innerText = "Secure Login";
        }
    };
</script>

</body>
</html>