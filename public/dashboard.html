<!-- 
<!DOCTYPE html>
<html lang="en">
<head>
  <title>Care Connect - Dashboard</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
  <style>
    body {
      background: linear-gradient(135deg, #f8f9fa 0%, #e3f2fd 50%, #e8f5e8 100%);
      font-family: 'Roboto', sans-serif;
      color: #2c3e50;
      margin: 0; padding: 0; min-height: 100vh; line-height: 1.6;
    }
    header {
      background-color: #ffffff; padding: 20px 40px;
      display: flex; justify-content: space-between; align-items: center;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); border-bottom: 3px solid #3498db;
    }
    .logo-container { display: flex; align-items: center; }
    .logo-img { width: 50px; height: 50px; margin-right: 15px; border-radius: 50%; object-fit: cover; }
    .logo { font-size: 32px; color: #2c3e50; font-weight: 700; font-family: "Gill Sans", "Gill Sans MT", Calibri, sans-serif; }
    
    .profile { position: relative; cursor: pointer; }
    .profile i {
      font-size: 35px; color: #3498db; border: 3px solid #3498db;
      border-radius: 50%; padding: 5px; background-color: #ffffff; transition: all 0.3s ease;
    }
    .profile i:hover { transform: scale(1.05); }
    
    .dropdown {
      display: none; position: absolute; right: 0; top: 50px;
      background-color: #ffffff; border: 2px solid #3498db; border-radius: 8px;
      min-width: 180px; z-index: 100; box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
    }
    .dropdown a {
      color: #2c3e50; padding: 12px 16px; text-decoration: none; display: block;
      font-size: 16px; font-weight: 500; transition: background-color 0.3s ease;
    }
    .dropdown a:hover { background-color: #ecf0f1; }

    .main-body {
      padding: 40px; display: flex; flex-direction: column; align-items: center;
      max-width: 1000px; margin: 0 auto;
    }
    .welcome { text-align: center; margin-bottom: 30px; }
    .welcome h1 { font-size: 32px; font-weight: 700; color: #2c3e50; }
    .welcome p { font-size: 16px; color: #7f8c8d; }

    /* --- HOSPITAL CARD --- */
    .hospitals-grid { width: 100%; margin-bottom: 40px; }
    .hospital-card {
      background: white; border: 1px solid #e1e8ed; border-radius: 12px; padding: 25px;
      cursor: pointer; transition: transform 0.2s; box-shadow: 0 4px 10px rgba(0,0,0,0.05);
      display: flex; align-items: center; position: relative; overflow: hidden;
    }
    .hospital-card::before {
      content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 4px;
      background: linear-gradient(90deg, #3498db 0%, #5dade2 50%, #85c1e9 100%);
    }
    .hospital-card:hover { transform: translateY(-3px); box-shadow: 0 8px 20px rgba(0,0,0,0.1); }
    .hospital-card i { font-size: 40px; color: #3498db; margin-right: 20px; }
    
    /* --- üìÇ DIGITAL RECORDS STYLES --- */
    #medical-history-container {
      width: 100%; background: white; padding: 30px;
      border-radius: 16px; box-shadow: 0 4px 15px rgba(0,0,0,0.05);
    }
    
    /* THE CARD STYLE */
    .history-card {
        border: 1px solid #e1e4e8; border-left: 5px solid #3498db;
        border-radius: 8px; padding: 20px; margin-bottom: 15px;
        background-color: #fafbfc; display: flex; flex-direction: column;
    }
    .history-header {
        display: flex; justify-content: space-between; margin-bottom: 12px;
        border-bottom: 1px solid #eee; padding-bottom: 8px;
    }
    .clinic-name { font-weight: bold; font-size: 18px; color: #2c3e50; }
    .record-date { color: #829ab1; font-size: 14px; font-weight: 500; }
    
    .history-details {
        display: grid; grid-template-columns: 1fr 1fr; gap: 15px;
    }
    .detail-item strong { 
        color: #7f8c8d; display: block; font-size: 12px; 
        text-transform: uppercase; margin-bottom: 4px;
    }
    .detail-item span { color: #2c3e50; font-weight: 500; font-size: 15px;}
    .rx-badge {
        color: #e74c3c; font-weight: bold;
    }

    .empty-state {
        text-align: center; padding: 40px; color: #829ab1;
    }
    .empty-state i { font-size: 48px; margin-bottom: 10px; color: #d9e2ec; }
  </style>
</head>

<body>

<header>
  <div class="logo-container">
    <img src="logo.jpeg" alt="Care Connect Logo" class="logo-img">
    <div class="logo">Care Connect</div>
  </div>
  <div class="profile" id="profile">
    <i class="fas fa-user-circle"></i>
    <div class="dropdown" id="dropdown">
      <a href="viewdetails.html"><i class="fas fa-user"></i> View My Details</a>
      <a href="change-details.html"><i class="fas fa-edit"></i> Edit My Details</a>
      <a href="#" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Log Out</a>
    </div>
  </div>
</header>

<div class="main-body">
  <div class="welcome">
    <h1>Welcome to Care Connect</h1>
    <p>Your gateway to quality healthcare in Goa. Connect with reliable providers.</p>
  </div>

  <div class="hospitals-grid">
    <div class="hospital-card" onclick="window.location.href='appointment-page.html'">
      <i class="fas fa-hospital"></i>
      <div class="content">
        <h3>Goa Medical College (GMC)</h3>
        <p>Bambolim, Central Goa</p>
      </div>
    </div>
  </div>

  <div id="medical-history-container">
    <h2 style="color: #2c3e50; margin-top:0; margin-bottom: 20px;">
      <i class="fas fa-folder-open" style="color:#f39c12;"></i> My Digital Records
    </h2>
    
    <div id="medical-history-list">
      <p style="text-align:center;">Loading your records...</p>
    </div>
  </div>

</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
  import { getFirestore, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const isLocal = window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1";
  
  const firebaseConfig = {
    apiKey: "AIzaSyDomNH7V0dxt_trHrUwghmUqd9eoUHxWYo",
    authDomain: "hospital-system-88ee9.firebaseapp.com",
    projectId: "hospital-system-88ee9",
    appId: "1:1052835799972:web:81b5f73457d76b777ad731"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // Auth & Navigation
  window.history.pushState(null, null, window.location.href);
  window.addEventListener('popstate', () => window.history.pushState(null, null, window.location.href));

  onAuthStateChanged(auth, (user) => {
    if (!user) window.location.href = "index.html";
    else listenToHistory(user.uid);
  });

  document.getElementById('logoutBtn').addEventListener('click', async (e) => {
    e.preventDefault();
    await signOut(auth);
    window.location.replace("login.html");
  });

  const profile = document.getElementById('profile');
  const dropdown = document.getElementById('dropdown');
  profile.addEventListener('click', () => dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block');
  window.addEventListener('click', (e) => { if (!profile.contains(e.target)) dropdown.style.display = 'none'; });

  /* ------------------------------------------------
     üî• STRICT STANDARD LISTENER (New Format Only)
     ------------------------------------------------ */
  function listenToHistory(uid) {
    const historyContainer = document.getElementById('medical-history-list');

    onSnapshot(doc(db, "users", uid), (docSnap) => {
        if (docSnap.exists() && docSnap.data().medicalHistory && docSnap.data().medicalHistory.length > 0) {
            
            // Get history array and reverse it (Newest First)
            const history = docSnap.data().medicalHistory.slice().reverse();
            historyContainer.innerHTML = "";

            history.forEach(h => {
                // 1. DATE FIX
                let dateString = "Unknown Date";
                if(h.date && h.date.seconds) {
                    dateString = new Date(h.date.seconds * 1000).toLocaleDateString("en-US", { year: 'numeric', month: 'long', day: 'numeric' });
                } else if (h.date) {
                    dateString = h.date;
                }

                // 2. üõë STRICT CHECK: Only looks for 'medication' and 'department'
                // It intentionally IGNORES 'prescription' and 'doctor'
                const medicine = h.medication || "None";
                const clinic = h.department || "General Clinic";

                // 3. GENERATE CARD
                const card = `
                    <div class="history-card">
                        <div class="history-header">
                            <div class="clinic-name">üè• ${clinic}</div>
                            <div class="record-date">${dateString}</div>
                        </div>
                        <div class="history-details">
                            <div class="detail-item">
                                <strong>Diagnosis</strong>
                                <span>${h.diagnosis || "N/A"}</span>
                            </div>
                            <div class="detail-item">
                                <strong>Medication</strong>
                                <span class="rx-badge">üíä ${medicine}</span>
                            </div>
                        </div>
                    </div>
                `;
                historyContainer.innerHTML += card;
            });

        } else {
            historyContainer.innerHTML = `<div class="empty-state"><i class="fas fa-folder"></i><p>No medical records found.</p></div>`;
        }
    });
  }
</script>

</body>
</html> -->
<!DOCTYPE html>
<html lang="en">
<head>
  <title>Care Connect - Dashboard</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
  <style>
    body {
      background: linear-gradient(135deg, #f8f9fa 0%, #e3f2fd 50%, #e8f5e8 100%);
      font-family: 'Roboto', sans-serif;
      color: #2c3e50;
      margin: 0; padding: 0; min-height: 100vh; line-height: 1.6;
    }
    header {
      background-color: #ffffff; padding: 20px 40px;
      display: flex; justify-content: space-between; align-items: center;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); border-bottom: 3px solid #3498db;
    }
    .logo-container { display: flex; align-items: center; }
    .logo-img { width: 50px; height: 50px; margin-right: 15px; border-radius: 50%; object-fit: cover; }
    .logo { font-size: 32px; color: #2c3e50; font-weight: 700; font-family: "Gill Sans", "Gill Sans MT", Calibri, sans-serif; }
    
    .profile { position: relative; cursor: pointer; }
    .profile i {
      font-size: 35px; color: #3498db; border: 3px solid #3498db;
      border-radius: 50%; padding: 5px; background-color: #ffffff; transition: all 0.3s ease;
    }
    .profile i:hover { transform: scale(1.05); }
    
    .dropdown {
      display: none; position: absolute; right: 0; top: 50px;
      background-color: #ffffff; border: 2px solid #3498db; border-radius: 8px;
      min-width: 180px; z-index: 100; box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
    }
    .dropdown a {
      color: #2c3e50; padding: 12px 16px; text-decoration: none; display: block;
      font-size: 16px; font-weight: 500; transition: background-color 0.3s ease;
    }
    .dropdown a:hover { background-color: #ecf0f1; }

    .main-body {
      padding: 40px; display: flex; flex-direction: column; align-items: center;
      max-width: 1000px; margin: 0 auto;
    }
    .welcome { text-align: center; margin-bottom: 30px; }
    .welcome h1 { font-size: 32px; font-weight: 700; color: #2c3e50; }
    .welcome p { font-size: 16px; color: #7f8c8d; }

    /* --- HOSPITAL CARD --- */
    .hospitals-grid { width: 100%; margin-bottom: 40px; }
    .hospital-card {
      background: white; border: 1px solid #e1e8ed; border-radius: 12px; padding: 25px;
      cursor: pointer; transition: transform 0.2s; box-shadow: 0 4px 10px rgba(0,0,0,0.05);
      display: flex; align-items: center; position: relative; overflow: hidden;
    }
    .hospital-card::before {
      content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 4px;
      background: linear-gradient(90deg, #3498db 0%, #5dade2 50%, #85c1e9 100%);
    }
    .hospital-card:hover { transform: translateY(-3px); box-shadow: 0 8px 20px rgba(0,0,0,0.1); }
    .hospital-card i { font-size: 40px; color: #3498db; margin-right: 20px; }
    
    /* --- üìÇ DIGITAL RECORDS STYLES --- */
    #medical-history-container {
      width: 100%; background: white; padding: 30px;
      border-radius: 16px; box-shadow: 0 4px 15px rgba(0,0,0,0.05);
    }
    
    /* THE CARD STYLE */
    .history-card {
        border: 1px solid #e1e4e8; border-left: 5px solid #3498db;
        border-radius: 8px; padding: 20px; margin-bottom: 15px;
        background-color: #fafbfc; display: flex; flex-direction: column;
    }
    .history-header {
        display: flex; justify-content: space-between; margin-bottom: 12px;
        border-bottom: 1px solid #eee; padding-bottom: 8px;
    }
    .clinic-name { font-weight: bold; font-size: 18px; color: #2c3e50; }
    .record-date { color: #829ab1; font-size: 14px; font-weight: 500; }
    
    .history-details {
        display: grid; grid-template-columns: 1fr 1fr; gap: 15px;
    }
    .detail-item strong { 
        color: #7f8c8d; display: block; font-size: 12px; 
        text-transform: uppercase; margin-bottom: 4px;
    }
    .detail-item span { color: #2c3e50; font-weight: 500; font-size: 15px;}
    .rx-badge {
        color: #e74c3c; font-weight: bold;
    }

    .empty-state {
        text-align: center; padding: 40px; color: #829ab1;
    }
    .empty-state i { font-size: 48px; margin-bottom: 10px; color: #d9e2ec; }
  </style>
</head>

<body>

<header>
  <div class="logo-container">
    <img src="logo.jpeg" alt="Care Connect Logo" class="logo-img">
    <div class="logo">Care Connect</div>
  </div>
  <div class="profile" id="profile">
    <i class="fas fa-user-circle"></i>
    <div class="dropdown" id="dropdown">
      <a href="viewdetails.html"><i class="fas fa-user"></i> View My Details</a>
      <a href="change-details.html"><i class="fas fa-edit"></i> Edit My Details</a>
      <a href="#" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Log Out</a>
    </div>
  </div>
</header>

<div class="main-body">
  <div class="welcome">
    <h1>Welcome to Care Connect</h1>
    <p>Your gateway to quality healthcare in Goa. Connect with reliable providers.</p>
  </div>

  <div class="hospitals-grid">
    <div class="hospital-card" onclick="window.location.href='appointment-page.html'">
      <i class="fas fa-hospital"></i>
      <div class="content">
        <h3>Goa Medical College (GMC)</h3>
        <p>Bambolim, Central Goa</p>
      </div>
    </div>
  </div>

  <div id="medical-history-container">
    <h2 style="color: #2c3e50; margin-top:0; margin-bottom: 20px;">
      <i class="fas fa-folder-open" style="color:#f39c12;"></i> My Digital Records
    </h2>
    
    <div id="medical-history-list">
      <p style="text-align:center;">Loading your records...</p>
    </div>
  </div>

</div>
<!-- 
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
  import { getFirestore, doc, onSnapshot, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
  // üî• NEW IMPORT FOR NOTIFICATIONS
  import { getMessaging, getToken, onMessage } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-messaging.js";

  const isLocal = window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1";
  
  const firebaseConfig = {
    apiKey: "AIzaSyDomNH7V0dxt_trHrUwghmUqd9eoUHxWYo",
    authDomain: "hospital-system-88ee9.firebaseapp.com",
    projectId: "hospital-system-88ee9",
    appId: "1:1052835799972:web:81b5f73457d76b777ad731",
    messagingSenderId: "1052835799972"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const messaging = getMessaging(app); // Initialize Messaging
  // ... after const messaging = getMessaging(app);

// üî• HANDLE FOREGROUND NOTIFICATIONS
// This triggers if you are looking at the website when the doctor calls
onMessage(messaging, (payload) => {
    console.log('Message received in foreground: ', payload);
    const { title, body } = payload.notification;
    
    // Show a standard browser alert (Simple & Effective for testing)
    alert(`üîî ${title}\n${body}`);
});

  // Auth & Navigation
  window.history.pushState(null, null, window.location.href);
  window.addEventListener('popstate', () => window.history.pushState(null, null, window.location.href));

  // üîî NOTIFICATION PERMISSION FUNCTION
  async function saveMessagingToken(user) {
    try {
        console.log("Requesting notification permission...");
        const permission = await Notification.requestPermission();
        
        if (permission === 'granted') {
            const token = await getToken(messaging, { 
                vapidKey: "BOT1Q21oyILkMsjOYypmL9r_2uAK3xspTUfptTFI-RPyhDAHT4Rr_jxvHkTo2r3EUi5mpTnpgelcFuIV6V7LOmg" // ‚ö†Ô∏è REPLACE THIS with your real Key
            });
            
            if (token) {
                console.log("FCM Token obtained:", token);
                // Save token to Firestore so the backend can find it later
                await updateDoc(doc(db, "users", user.uid), {
                    fcmToken: token
                });
                console.log("Notification Token Saved to DB!");
            }
        } else {
            console.log("Permission denied for notifications.");
        }
    } catch (error) {
        console.error("Notification permission error:", error);
    }
  }

  // Auth Listener
  onAuthStateChanged(auth, (user) => {
    if (!user) {
        window.location.href = "index.html";
    } else {
        listenToHistory(user.uid);
        saveMessagingToken(user); // üî• TRIGGER PERMISSION REQUEST
    }
  });

  document.getElementById('logoutBtn').addEventListener('click', async (e) => {
    e.preventDefault();
    await signOut(auth);
    window.location.replace("login.html");
  });

  const profile = document.getElementById('profile');
  const dropdown = document.getElementById('dropdown');
  profile.addEventListener('click', () => dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block');
  window.addEventListener('click', (e) => { if (!profile.contains(e.target)) dropdown.style.display = 'none'; });

  /* ------------------------------------------------
     üî• STRICT STANDARD LISTENER (New Format Only)
     ------------------------------------------------ */
  function listenToHistory(uid) {
    const historyContainer = document.getElementById('medical-history-list');

    onSnapshot(doc(db, "users", uid), (docSnap) => {
        if (docSnap.exists() && docSnap.data().medicalHistory && docSnap.data().medicalHistory.length > 0) {
            
            // Get history array and reverse it (Newest First)
            const history = docSnap.data().medicalHistory.slice().reverse();
            historyContainer.innerHTML = "";

            history.forEach(h => {
                // 1. DATE FIX
                let dateString = "Unknown Date";
                if(h.date && h.date.seconds) {
                    dateString = new Date(h.date.seconds * 1000).toLocaleDateString("en-US", { year: 'numeric', month: 'long', day: 'numeric' });
                } else if (h.date) {
                    dateString = h.date;
                }

                // 2. üõë STRICT CHECK
                const medicine = h.medication || "None";
                const clinic = h.department || "General Clinic";

                // 3. GENERATE CARD
                const card = `
                    <div class="history-card">
                        <div class="history-header">
                            <div class="clinic-name">üè• ${clinic}</div>
                            <div class="record-date">${dateString}</div>
                        </div>
                        <div class="history-details">
                            <div class="detail-item">
                                <strong>Diagnosis</strong>
                                <span>${h.diagnosis || "N/A"}</span>
                            </div>
                            <div class="detail-item">
                                <strong>Medication</strong>
                                <span class="rx-badge">üíä ${medicine}</span>
                            </div>
                        </div>
                    </div>
                `;
                historyContainer.innerHTML += card;
            });

        } else {
            historyContainer.innerHTML = `<div class="empty-state"><i class="fas fa-folder"></i><p>No medical records found.</p></div>`;
        }
    });
  }
</script> -->

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
  import { getFirestore, doc, onSnapshot, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
  import { getMessaging, getToken, onMessage } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-messaging.js";

  const isLocal = window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1";
  
  const firebaseConfig = {
    apiKey: "AIzaSyDomNH7V0dxt_trHrUwghmUqd9eoUHxWYo",
    authDomain: "hospital-system-88ee9.firebaseapp.com",
    projectId: "hospital-system-88ee9",
    appId: "1:1052835799972:web:81b5f73457d76b777ad731",
    messagingSenderId: "1052835799972"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // üõ°Ô∏è SAFELY INITIALIZE MESSAGING (Prevents crash if notifications fail)
  let messaging;
  try {
    messaging = getMessaging(app);
    onMessage(messaging, (payload) => {
        console.log('Message received in foreground: ', payload);
        const { title, body } = payload.notification;
        alert(`üîî ${title}\n${body}`);
    });
  } catch (err) {
    console.warn("‚ö†Ô∏è Notifications not supported or failed to init (This is okay).", err);
  }

  // Auth & Navigation
  window.history.pushState(null, null, window.location.href);
  window.addEventListener('popstate', () => window.history.pushState(null, null, window.location.href));

  // Auth Listener
  onAuthStateChanged(auth, (user) => {
    if (!user) {
        window.location.href = "index.html";
    } else {
        console.log("üë§ User Logged In:", user.uid);
        // 1. LOAD HISTORY FIRST (Priority)
        listenToHistory(user.uid);
        
        // 2. THEN TRY NOTIFICATIONS
        if (messaging) saveMessagingToken(user);
    }
  });

  // üîî NOTIFICATION PERMISSION FUNCTION
  async function saveMessagingToken(user) {
    try {
        const permission = await Notification.requestPermission();
        if (permission === 'granted') {
            const token = await getToken(messaging, { 
                vapidKey: "BOT1Q21oyILkMsjOYypmL9r_2uAK3xspTUfptTFI-RPyhDAHT4Rr_jxvHkTo2r3EUi5mpTnpgelcFuIV6V7LOmg"
            });
            if (token) {
                await updateDoc(doc(db, "users", user.uid), { fcmToken: token });
                console.log("‚úÖ Notification Token Saved!");
            }
        }
    } catch (error) {
        console.log("‚ö†Ô∏è Notification error (ignored):", error);
    }
  }

  document.getElementById('logoutBtn').addEventListener('click', async (e) => {
    e.preventDefault();
    await signOut(auth);
    window.location.replace("login.html");
  });

  const profile = document.getElementById('profile');
  const dropdown = document.getElementById('dropdown');
  profile.addEventListener('click', () => dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block');
  window.addEventListener('click', (e) => { if (!profile.contains(e.target)) dropdown.style.display = 'none'; });

  /* ------------------------------------------------
      üî• HISTORY LISTENER WITH DEBUGGING
     ------------------------------------------------ */
  function listenToHistory(uid) {
    const historyContainer = document.getElementById('medical-history-list');

    console.log("üì° Listening for medical records...");

    onSnapshot(doc(db, "users", uid), (docSnap) => {
        if (!docSnap.exists()) {
            console.log("‚ùå User document does not exist yet.");
            return;
        }

        const userData = docSnap.data();
        console.log("üìÑ Full User Data:", userData); // <--- CHECK CONSOLE FOR THIS

        // Check specifically for 'medicalHistory'
        if (userData.medicalHistory && userData.medicalHistory.length > 0) {
            
            console.log("‚úÖ Found Records:", userData.medicalHistory);
            
            const history = userData.medicalHistory.slice().reverse();
            historyContainer.innerHTML = "";

            history.forEach(h => {
                // 1. DATE FIX
                let dateString = "Unknown Date";
                if(h.date && h.date.seconds) {
                    dateString = new Date(h.date.seconds * 1000).toLocaleDateString("en-US", { year: 'numeric', month: 'long', day: 'numeric' });
                } else if (h.date) {
                    dateString = h.date;
                }

                // 2. MAPPING (Your DB uses 'medication' and 'department')
                const medicine = h.medication || "None";
                const clinic = h.department || "General Clinic";
                const diagnosis = h.diagnosis || "N/A";

                const card = `
                    <div class="history-card">
                        <div class="history-header">
                            <div class="clinic-name">üè• ${clinic}</div>
                            <div class="record-date">${dateString}</div>
                        </div>
                        <div class="history-details">
                            <div class="detail-item">
                                <strong>Diagnosis</strong>
                                <span>${diagnosis}</span>
                            </div>
                            <div class="detail-item">
                                <strong>Medication</strong>
                                <span class="rx-badge">üíä ${medicine}</span>
                            </div>
                        </div>
                    </div>
                `;
                historyContainer.innerHTML += card;
            });

        } else {
            console.log("‚ö†Ô∏è 'medicalHistory' array is missing or empty.");
            historyContainer.innerHTML = `<div class="empty-state"><i class="fas fa-folder"></i><p>No medical records found.</p></div>`;
        }
    });
  }
</script>

</body>
</html>