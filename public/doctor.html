<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Doctor Panel - Queue Monitor</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        /* --- ORIGINAL CSS --- */
        body { background: linear-gradient(135deg, #f8f9fa 0%, #e3f2fd 50%, #e8f5e8 100%); font-family: 'Roboto', sans-serif; color: #2c3e50; margin: 0; padding: 0; height: 100vh; }
        header { background-color: #ffffff; padding: 20px 40px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); border-bottom: 3px solid #3498db; }
        .logo-container { display: flex; align-items: center; }
        .logo-img { width: 50px; height: 50px; margin-right: 15px; border-radius: 50%; object-fit: cover; }
        .logo { font-size: 32px; color: #2c3e50; font-weight: 700; }
        .main-body { padding: 60px 40px; display: flex; flex-direction: column; align-items: center; max-width: 1200px; margin: 0 auto; }
        .container { background-color: #ffffff; padding: 40px; border-radius: 16px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); width: 100%; max-width: 600px; text-align: center; border: 1px solid #e1e8ed; position: relative; }
        .container::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 4px; background: linear-gradient(90deg, #3498db 0%, #5dade2 50%, #85c1e9 100%); }
        h1 { color: #2c3e50; margin-bottom: 20px; font-size: 32px; font-weight: 700; }
        label { font-weight: 600; color: #2c3e50; display: block; text-align: left; margin-bottom: 8px; }
        select { width: 100%; padding: 12px; margin: 10px 0 20px 0; border-radius: 8px; border: 2px solid #b0c4de; font-size: 16px; background-color: #f9f9f9; }
        .current-patient-box { background: linear-gradient(135deg, #e3f2fd 0%, #f1f8ff 100%); padding: 20px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #b3d7ff; }
        #currentPatient { font-size: 28px; font-weight: bold; color: #3498db; }
        #nextBtn { background-color: #3498db; color: white; border: none; padding: 15px 30px; border-radius: 8px; font-size: 18px; cursor: pointer; width: 100%; font-weight: bold; transition: 0.3s; }
        #nextBtn:hover { background-color: #2980b9; }
        #queueList { list-style: none; padding: 0; margin-top: 20px; text-align: left; max-height: 200px; overflow-y: auto; }
        #queueList li { padding: 12px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; font-size: 15px; background-color: #f9f9f9; border-radius: 6px; margin-bottom: 5px; }
        
        /* --- NEW MODAL CSS --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 1000;
            display: none; justify-content: center; align-items: center;
        }
        .modal-content {
            background: white; width: 90%; max-width: 500px;
            border-radius: 10px; padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            max-height: 90vh; overflow-y: auto; text-align: left;
        }
        .view-btn {
            background: #2ecc71; color: white; border: none; padding: 5px 10px;
            border-radius: 4px; cursor: pointer; font-size: 12px; margin-left: 10px;
        }
        .view-btn:hover { background: #27ae60; }
    </style>
</head>

<body>
    <header>
        <div class="logo-container">
            <img src="logo.jpeg" alt="Logo" class="logo-img">
            <div class="logo">Care Connect</div>
        </div>
    </header>

    <div class="main-body">
        <div class="container">
            <h1>Doctor Panel</h1>

            <label for="clinicSelect">Current Clinic Location</label>
            <select id="clinicSelect">
                <option value="">-- Choose Clinic --</option>
                <option value="Dermatology">Dermatology</option>
                <option value="Orthopedics">Orthopedics</option>
                <option value="Cardiology">Cardiology</option>
                <option value="ENT">ENT</option>
            </select>

            <div class="current-patient-box">
                <h3>Now Serving</h3>
                <div id="currentPatient">None</div>
                <div id="statusMsg" style="display:none; color:green; margin-top:5px;"></div>
                <button id="viewCurrentBtn" style="display:none; margin-top:10px; background:#2ecc71; border:none; color:white; padding:5px 15px; border-radius:5px; cursor:pointer;">
                    üìÇ View Medical History
                </button>
            </div>

            <button id="nextBtn">Call Next Patient</button>

            <div style="margin-top: 30px; text-align: left;">
                <strong>Waiting Queue:</strong>
                <ul id="queueList"></ul>
            </div>

            <div style="margin-top: 15px; font-weight: bold; color: #666;">
                Est. Total Wait: <span id="eta" style="color: #d9534f;">‚Äî</span>
            </div>
            
            <button id="resetBtn" style="background:#e74c3c; color:white; padding:10px; border:none; border-radius:8px; margin-top:20px; cursor:pointer;">Reset Daily Counters</button>
        </div>
    </div>

    <div id="modalOverlay" class="modal-overlay">
        <div id="patient-details-modal" class="modal-content">
            </div>
    </div>

<script type="module">
    // AUTOMATICALLY DETECT ENVIRONMENT
    const isLocal = window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1";
    const BASE_URL = isLocal 
        ? "http://localhost:5000" 
        : "https://hospital-appointment-system-oogs.onrender.com";

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { 
        getFirestore, collection, getDocs, deleteDoc, query, orderBy, onSnapshot, 
        doc, setDoc, getDoc, updateDoc, arrayUnion 
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // CONFIG
    const firebaseConfig = {
        apiKey: "AIzaSyDomNH7V0dxt_trHrUwghmUqd9eoUHxWYo",
        authDomain: "hospital-system-88ee9.firebaseapp.com",
        projectId: "hospital-system-88ee9",
        appId: "1:1052835799972:web:81b5f73457d76b777ad731"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const AVG_TIME = 15;

    const clinicSelect = document.getElementById("clinicSelect");
    const queueList = document.getElementById("queueList");
    const currentBox = document.getElementById("currentPatient");
    const viewCurrentBtn = document.getElementById("viewCurrentBtn");
    const etaBox = document.getElementById("eta");
    const nextBtn = document.getElementById("nextBtn");
    const statusMsg = document.getElementById("statusMsg");

    let queueRef = null;
    let unsubscribe = null;

    /* üîÅ 1. Real-time Queue Monitor */
    clinicSelect.onchange = () => {
        if (unsubscribe) unsubscribe();
        const clinic = clinicSelect.value;
        if (!clinic) return;

        queueRef = collection(db, "queue", clinic, "patients");
        const q = query(queueRef, orderBy("time", "asc"));

        unsubscribe = onSnapshot(q, (snapshot) => {
            queueList.innerHTML = "";
            let count = 0;
            snapshot.forEach((docSnap) => {
                const d = docSnap.data();
                const li = document.createElement("li");
                li.innerHTML = `
                    <span>Token <strong>#${d.token}</strong> - ${d.name}</span>
                    <button class="view-btn" onclick="window.viewPatientDetails('${d.uid}')">View</button>
                `;
                queueList.appendChild(li);
                count++;
            });
            etaBox.textContent = count > 0 ? `${count * AVG_TIME} minutes` : "Queue Empty";
        });
    };

    /* ‚ñ∂Ô∏è 2. Call Next Patient */
    nextBtn.onclick = async () => {
        const clinic = clinicSelect.value;
        if (!clinic) return alert("Select a clinic");

        const q = query(queueRef, orderBy("time", "asc"));
        const snap = await getDocs(q);

        if (snap.empty) {
            currentBox.textContent = "None";
            viewCurrentBtn.style.display = "none";
            return;
        }

        const firstDoc = snap.docs[0];
        const d = firstDoc.data();

        // Update UI
        currentBox.innerHTML = `Token #${d.token}<br><small>${d.name}</small>`;
        
        // Show View Button
        viewCurrentBtn.style.display = "inline-block";
        viewCurrentBtn.onclick = () => window.viewPatientDetails(d.uid);

        // Update Backend Status
        await setDoc(doc(db, "clinic_status", clinic), { currentlyServing: d.token }, { merge: true });

        // Trigger Notification
        triggerNotification(d, snap.docs, clinic);

        // Remove from Queue
        await deleteDoc(firstDoc.ref);
    };

    async function triggerNotification(currentData, allDocs, clinic) {
        const targetToken = ((Number(currentData.token) + 2) % 50) + 1; 
        const luckyPatient = allDocs.find(doc => Number(doc.data().token) === Number(targetToken));
        
        if (luckyPatient) {
            const p = luckyPatient.data();
            fetch(`${BASE_URL}/api/auth/trigger-instant-relay`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ phone: p.phone, userName: p.name, clinicName: clinic, tokenNumber: p.token, email: p.email })
            }).then(() => {
                statusMsg.textContent = `Alert sent to Token #${p.token}`;
                statusMsg.style.display = "block";
                setTimeout(() => statusMsg.style.display = "none", 3000);
            });
        }
    }

    /* =========================================
       3. VIEW PATIENT & ADD DETAILS (THE FIX)
       ========================================= */

    window.viewPatientDetails = function(patientId) {
        if(!patientId) return alert("Error: No Patient ID found");

        const modal = document.getElementById("patient-details-modal");
        const overlay = document.getElementById("modalOverlay");
        
        modal.innerHTML = "<p>Loading records...</p>";
        overlay.style.display = "flex";

        getDoc(doc(db, "users", patientId)).then((docSnap) => {
            if (docSnap.exists()) {
                const data = docSnap.data();
                
                // Show History
                let historyHtml = '<p style="color:grey; font-style:italic;">No past records found.</p>';
                if (data.medicalHistory && data.medicalHistory.length > 0) {
                    historyHtml = `<ul style="max-height:150px; overflow-y:auto; padding-left:20px; border:1px solid #eee; padding:10px;">
                        ${data.medicalHistory.slice().reverse().map(item => 
                            `<li style="margin-bottom:10px;">
                                <strong>${item.date}:</strong> ${item.diagnosis} <br>
                                <span style="color:#666; font-size:0.9em;">üíä ${item.medication || item.prescription}</span>
                            </li>`
                        ).join('')}
                    </ul>`;
                }

                // üìù HERE IS THE INPUT FORM FOR THE DOCTOR
                modal.innerHTML = `
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <h3>${data.name} <span style="font-size:0.7em; color:grey">(${data.bloodGroup || 'Blood Type N/A'})</span></h3>
                        <button onclick="closeModal()" style="background:none; border:none; font-size:20px; cursor:pointer;">‚úñ</button>
                    </div>

                    <div style="background:#f9f9f9; padding:10px; border-radius:5px; margin-bottom:15px;">
                        <strong>üìÇ Medical History:</strong>
                        ${historyHtml}
                    </div>

                    <div class="consultation-form" style="border-top:2px solid #eee; padding-top:10px;">
                        <h4 style="margin-top:0;">üìù Today's Consultation</h4>
                        
                        <label style="font-size:12px;">Diagnosis</label>
                        <input type="text" id="doc-diagnosis" placeholder="e.g. Viral Fever" style="width:100%; padding:10px; margin-bottom:10px; box-sizing:border-box;">
                        
                        <label style="font-size:12px;">Medication / Prescription</label>
                        <input type="text" id="doc-medication" placeholder="e.g. Paracetamol 500mg" style="width:100%; padding:10px; margin-bottom:10px; box-sizing:border-box;">
                        
                        <button onclick="updatePatientRecord('${patientId}')" style="background:#27ae60; color:white; padding:12px; width:100%; border:none; border-radius:5px; cursor:pointer; font-weight:bold;">
                            ‚úÖ Save & Complete Visit
                        </button>
                    </div>
                `;
            } else {
                modal.innerHTML = "<p>Error: Patient profile not found.</p><button onclick='closeModal()'>Close</button>";
            }
        });
    }

    window.closeModal = function() {
        document.getElementById("modalOverlay").style.display = "none";
    }

    // üíæ 4. SAVE TO DATABASE (Aligns with Dashboard)
    window.updatePatientRecord = function(patientId) {
        const diagnosis = document.getElementById("doc-diagnosis").value;
        const medication = document.getElementById("doc-medication").value;
        const clinicName = document.getElementById("clinicSelect").value; // Gets "Dermatology", "ENT", etc.
        
        if(!diagnosis) return alert("Please enter a diagnosis.");

        const today = new Date().toLocaleDateString("en-US", { year: 'numeric', month: 'long', day: 'numeric' });

        // üî• CRITICAL: Field names must match Dashboard logic
        const newVisit = {
            date: today,
            diagnosis: diagnosis,
            medication: medication || "None", // Saved as 'medication'
            department: clinicName || "General Clinic" // Saved as 'department'
        };

        updateDoc(doc(db, "users", patientId), {
            medicalHistory: arrayUnion(newVisit)
        }).then(() => {
            alert("Record Saved!");
            window.closeModal();
        }).catch((error) => {
            console.error("Error updating record:", error);
            alert("Failed to update record.");
        });
    }
</script>
</body>
</html>